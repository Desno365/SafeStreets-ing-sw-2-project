<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>SafeStreets Municipality Interface</title>
	<link href="stylesheets/TemplateStylesheet.css" media="screen" rel="stylesheet" type="text/css"/>
</head>
<body>

<script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-storage.js"></script>
<script src="scripts/api.js"></script>

<style>
	div.details txt {
		display: block;
		margin-left: 10px;
		padding-bottom: 23px;
	}

	div.infos {
		display: block;
		margin-left: 100px;
	}

	div.infos titles {
		display: block;
		margin-left: 50px;
	}

	div.infos titles {
		display: block;
		font-size: x-large;
		font-weight: bolder;
	}

	div.infos txt.one {
		padding-right: 200px;
	}

	div.infos txt.two {
		margin-left: 20%;
	}

	div.boxes {
		margin-top: 15px;
	}

	div.box {
		display: inline-block;
		border: 1px solid black;
		height: 300px;
		word-wrap: break-word;
		vertical-align: top;
	}

	div.box[id="descr"] {
		width: 250px;
		margin-right: 50px;
	}

	div.box[id="pic"] {
		margin-left: 20%;
		width: 250px;
		max-width: 400px;
		height: fit-content;
	}

	img {
		/*-webkit-transform: rotate(90deg);
		-moz-transform: rotate(90deg);
		-ms-transform: rotate(90deg);
		-o-transform: rotate(90deg);
		transform: rotate(90deg);*/
		cursor: pointer;
		padding-left: 15px;
		padding-top: 10px;
		padding-bottom: 15px;
	}


</style>


<div class="center">SafeStreets Municipality Interface</div>

<ul class="hamburger-menu">
	<li class="active"><a href="AcceptViolations.html">Accept Violations</a></li>
	<li><a href="DisplayData.html">Display Data</a></li>
	<li><a href="ShowStatistics.html">Show Statistics</a></li>
	<lg id="logout">Logout</lg>
</ul>

<div class="content">
	<div class="details">
		<txt id="id">Group id:		</txt>
		<txt id="num">Number of reports:		</txt>
		<txt id="loc">Location:		</txt>
		<txt id="licp">License plate:		</txt>
		<txt id="vtype">Violation type:		</txt>
		<txt id="time">Time:		</txt>
	</div>

	<div class="infos">
		<titles>
			<txt class="one">Descriptions</txt>
			<txt class="two">Pictures</txt>
		</titles>

		<div class="boxes">
			<div class="box" id="descr">

			</div>

			<div class="box" id="pic">

			</div>
		</div>
	</div>
</div>


<script>
    //RETRIEVE REPORT DATA
    var groupId = location.hash.toString();
    groupId = groupId.slice(1);
    var db = firebase.firestore();
    var storage = firebase.storage().ref();
    var picturesCollection;
    var reportsNumber = 0;
    var locationOnMap = "";
    var licensePlate;
    var time;
    var violationType;
    var descriptions = [];
    var groups = db.collection("municipalities").doc(sessionStorage.municip).collection("groups");

    groups.doc(groupId).get().then(function (groupDocumentSnapshot) {
        if (groupDocumentSnapshot.exists) {
            //Get location, licensePlate, time, violationType
            locationOnMap = groupDocumentSnapshot.get("latitude") + "  |  " + groupDocumentSnapshot.get("longitude");
            licensePlate = groupDocumentSnapshot.get("licensePlate");
            time = "Between " + new Date(groupDocumentSnapshot.get("firstTimestamp").seconds * 1000) + " and " + new Date(groupDocumentSnapshot.get("lastTimestamp").seconds * 1000);
            violationType = groupDocumentSnapshot.get("typeOfViolation");

            //Take the reports of the group. For each report, get the description and its pictures
            let reports = groupDocumentSnapshot.get("reports");
            reports.forEach(function (repoId) {
                let report = db.collection("violationReports").doc(repoId);
                report.get().then(function (reportSnapshot) {
                    if (reportSnapshot.exists) {
                        document.getElementById("num").textContent += ++reportsNumber;
                        document.getElementById("descr").innerText += reportSnapshot.get("description");
                        console.log(reportSnapshot.get("description"));
                        picturesCollection = reportSnapshot.get("pictures");

                        //Retrieve pictures of the report
						userid = reportSnapshot.get("userUid");
                        if (picturesCollection) {
                            picturesCollection.forEach(function (value) {
                                storage.child("pictures/" + userid + "/" + value).getDownloadURL().then(function (url) {
                                    var newImg = document.createElement("img");
                                    newImg.setAttribute("src", url);
                                    newImg.setAttribute("width", 100);
                                    newImg.setAttribute("height", 100);
                                    newImg.addEventListener("click", function () {
                                        openPic(url);
                                    });
                                    document.getElementById("pic").appendChild(newImg);
                                }).catch(function (error) {
                                    console.log("There has been an error. " + error);
                                })
                            });
                        }
                    }
                })
            });
        }
        document.getElementById("id").textContent += groupId;
        document.getElementById("loc").textContent += locationOnMap;
        document.getElementById("licp").textContent += licensePlate;
        document.getElementById("time").textContent += time;
        document.getElementById("vtype").textContent += violationType;
    });

    function deprecatedRetrieve() {
        var report = firebase.firestore().collection("violationReports").doc(groupId).get().then(function (documentSnapshot) {
            if (documentSnapshot.exists) {
                document.getElementById("id").textContent += documentSnapshot.id;
                document.getElementById("num").textContent += "not implemented yet.";
                document.getElementById("loc").textContent += documentSnapshot.get("latitude") + "  |  " + documentSnapshot.get("longitude");
                var licensePlate = documentSnapshot.get("licensePlate");
                if (!licensePlate) licensePlate = documentSnapshot.get("licencePlate");
                document.getElementById("licp").textContent += licensePlate;
                try {
                    document.getElementById("time").textContent += new Date(documentSnapshot.get("uploadTimestamp").seconds * 1000);
                } catch (e) {
                    console.log("do absolutely nothing");
                }
                document.getElementById("vtype").textContent += documentSnapshot.get("violationType");
                document.getElementById("descr").innerText += documentSnapshot.get("description");
                picturesCollection = documentSnapshot.get("pictures");
                userid = documentSnapshot.get("userUid");
            } else {
                console.log("report doesn't exists");
            }
            //RETRIEVE REPORT PICTURES
            if (picturesCollection) {
                picturesCollection.forEach(function (pictures) {
                    pictures.forEach(function (value) {
                        console.log("PATH: " + "pictures/" + userid + "/" + value + ".jpeg");
                        storage.child("pictures/" + userid + "/" + value).getDownloadURL().then(function (url) {
                            console.log(url);
                            newImg = document.createElement("img");
                            newImg.setAttribute("src", url);
                            newImg.setAttribute("width", 100);
                            newImg.setAttribute("height", 100);
                            newImg.addEventListener("click", function () {
                                openPic(url);
                            });
                            document.getElementById("pic").appendChild(newImg);
                        }).catch(function (error) {
                            console.log("There has been an error. " + error);
                        });
                    });
                });
            }
        });
    }

    function openPic(picUrl) {
        window.open(picUrl);
    }

</script>


<script src="scripts/logout.js"></script>
</body>
</html>